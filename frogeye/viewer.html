<!doctype html>
<title>Frogeye Viewer</title>
<link rel="icon" type="image/png"  href="img/favicon.png">
<style>
* {box-sizing: border-box; }
h1, h3 {margin: 0.5em 0; font-weight: normal; }
h1 img {margin: 0 10px 0 0; vertical-align: middle; }
#frogeye {
    margin: 0 10px 10px 0;
    position: relative;
    overflow; auto;
    width: 400px; height: 300px;
    border: 1px solid #333;
    float: left;
    background: #000;
}
#frogeye > div, #frogeye canvas {
    position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
}
#state {
    padding: 0 1em;
    width: 400px;
    float: left;
    color: #fff;
    background: #000;
}
#brightness {background-color: #333; }
#loc > div {width: 25%; height: 33.333%; float: left; }
</style>

<article>
<h1><img src="img/favicon.png">Frogeye Viewer</h1>

<div id="frogeye">
    <div id="brightness"></div>

    <div id="loc">
        <div></div><div></div><div></div><div></div>
        <div></div><div></div><div></div><div></div>
        <div></div><div></div><div></div><div></div>
    </div>

    <canvas id="edges" width="400" height="300"></canvas>
    <canvas id="ball" width="400" height="300"></canvas>
    <canvas id="target" width="400" height="300"></canvas>
</div>

<div id="state">
<h3>Sense State</h3>
<pre id="senseState"></pre>
</div>

</article>

<script src="/socket.io/socket.io.js"></script>
<script>
var socket, canvasEdge, ctxEdge, canvasBall, ctxBall;

function displayOverallBrightness(brightnessNormalized) {
    var to8Bit = Math.floor(brightnessNormalized * 256),
        brightnessAmplified = brightnessNormalized * 2.5,
        rgbaShade,
        brightnessDiv = document.getElementById('brightness');

    if (brightnessAmplified > 1.0) {
        brightnessAmplified = 1.0;
    }
    rgbaShade = 'rgba(255, 255, 255, ' + brightnessAmplified + ')';
    brightnessDiv.style.backgroundColor = rgbaShade;
}

function displayMotionLocation(dir) {
    var motionDivs = document.querySelectorAll('#loc div'), ii, len;
    len = motionDivs.length;

    for (ii = 0; ii < len; ii += 1) {
        if (dir[ii] > 0.01) {
            motionDivs[ii].style.backgroundColor = 'rgba(0, 255, 0, ' + dir[ii].toFixed(2) + ')';
        } else {
            motionDivs[ii].style.backgroundColor = 'transparent';
        }
    }
}

function displayEdges(edges) {
    ctxEdge.clearRect(0, 0, canvasEdge.width, canvasEdge.height);

    edges.forEach(function (edge) {
        var x = edge % 64,
            y = Math.floor(edge / 64);

        ctxEdge.beginPath();
        ctxEdge.moveTo(x * 6.25 - 3.125, y * 6.25);
        ctxEdge.lineTo(x * 6.25 + 3.125, y * 6.25);
        ctxEdge.stroke();

        ctxEdge.beginPath();
        ctxEdge.moveTo(x * 6.25, y * 6.25 - 3.125);
        ctxEdge.lineTo(x * 6.25, y * 6.25 + 3.125);
        ctxEdge.stroke();
    });
}

function displayBall(loc) {
    var x, y;
    ctxBall.clearRect(0, 0, canvasBall.width, canvasBall.height);

    if (loc > -1) {
        x = (loc % 32) * 2;
        y = Math.floor(loc / 32) * 2;

        ctxBall.beginPath();
        ctxBall.arc(x * 6.25, y * 6.25, 10, 0, Math.PI * 2, true);
        ctxBall.closePath();
        ctxBall.fill();
    }
}

function senseStateReceived(senseState) {
    var jsonState = JSON.parse(senseState),
        jsonString = JSON.stringify(jsonState, null, '    ');

    document.getElementById('senseState').innerHTML = jsonString;
    displayOverallBrightness(jsonState.brightnessOverall);
    displayMotionLocation(jsonState.motionLocation);
    displayEdges(jsonState.edges);
    displayBall(jsonState.ball);
}

function init() {
    var canvasTarget = document.getElementById('target'),
        ctxTarget = canvasTarget.getContext("2d");

    ctxTarget.strokeRect(30 * 6.25, 22 * 6.25, 4 * 6.25, 4 * 6.25);

    socket = io();

    canvasEdge = document.getElementById('edges');
    ctxEdge = canvasEdge.getContext("2d");
    ctxEdge.strokeStyle = 'black';
    ctxEdge.lineWidth = 1;

    canvasBall = document.getElementById('ball');
    ctxBall = canvasBall.getContext("2d");
    ctxBall.strokeRect(30 * 6.25, 22 * 6.25, 4 * 6.25, 4 * 6.25);
    ctxBall.fillStyle = 'rgba(255, 0, 255, 0.5)';

    socket.on('senseState', senseStateReceived);
}

init();

</script>
