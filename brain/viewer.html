<!doctype html>
<title>Fetchbot Brain Viewer</title>
<link rel="icon" type="image/png"  href="img/favicon.png">
<style>
* {box-sizing: border-box; }
h1, h3 {margin: 0.5em 0; font-weight: normal; }
h1 img {margin: 0 10px 0 0; vertical-align: middle; }
.column {
    margin: 0 8px 8px;
    width: 400px;
    float: left;
    overflow: auto;
}
#frogeye {
    margin: 0 10px 10px 0;
    position: relative;
    overflow; auto;
    width: 400px; height: 300px;
    border: 1px solid #333;
    float: left;
    background: #000;
}
#frogeye > div, #frogeye canvas {
    position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
}
#state {
    padding: 0 1em;
    color: #fff;
    background: #000;
}

#brightness {background-color: #333; }
#loc > div {width: 25%; height: 33.333%; float: left; }

#controls button {
    margin: 0 1em;
    width: 104px;
}

</style>

<article>
<h1><img src="img/favicon.png">Fetchbot Brain Viewer</h1>

<div id="hud" class="column">
<div id="frogeye">
    <div id="brightness"></div>
    <canvas id="edges" width="400" height="300"></canvas>
    <canvas id="ball" width="400" height="300"></canvas>
</div>

<div id="manual">
<p><button onclick="manual()">Request manual control</button>
</div>

<div id="controls">
<p><button onclick="move('forwardleft')">travel left</button>
    <button onclick="move('forward')">forward</button>
    <button onclick="move('forwardright')">travel right</button>
<p><button onclick="move('rotateleft')">rotate left</button>
    <button onclick="move('stop')">stop</button>
    <button onclick="move('rotateright')">rotate right</button>
<p><button onclick="move('backleft')">bacward left</button>
    <button onclick="move('backward')">backward</button>
    <button onclick="move('backright')">backward right</button>
</div>
</div>

<div id="behaviors" class="column">
<h3>Behaviors</h3>
<p id="moods"></p>
<div id="behaviorTable"></div>
</div>

<div id="state" class="column">
<h3>Sense State</h3>
<pre id="senseState"></pre>
</div>

</article>

<script src="/socket.io/socket.io.js"></script>
<script>
var socket, canvasEdge, ctxEdge, canvasBall, ctxBall, viewWidth, mag, halfMag, width, stateHash = 0, control = 'auto', manualOverrideTimer;

/* From http://stackoverflow.com/questions/7616461#answer-7616484 */
function hashCode(s) {
    var hash = 0, i, chr, len = s.length;
    if (len === 0) {
        return hash;
    }
    for (i = 0; i < len; i++) {
        chr = s.charCodeAt(i);
        hash = ((hash << 5) - hash) + chr;
        hash |= 0; // Convert to 32bit integer
    }
    return hash;
}

function displayOverallBrightness(brightnessNormalized) {
    var brightnessAmplified = brightnessNormalized + 0.1,
        rgbaShade,
        brightnessDiv = document.getElementById('brightness');

    if (brightnessAmplified > 1.0) {
        brightnessAmplified = 1.0;
    }
    rgbaShade = 'rgba(255, 255, 255, ' + brightnessAmplified + ')';
    brightnessDiv.style.backgroundColor = rgbaShade;
}

function displayEdges(edges) {
    ctxEdge.clearRect(0, 0, canvasEdge.width, canvasEdge.height);

    edges.forEach(function (edge) {
        var x = (edge % width) * mag,
            y = (Math.floor(edge / width)) * mag,
            gradient = ctxEdge.createRadialGradient(x, y, 0, x, y, mag * 1.5);

        ctxEdge.beginPath();
        gradient.addColorStop(0, 'black');
        gradient.addColorStop(0.7, 'rgba(0, 0, 0, 0.1)');
        gradient.addColorStop(1, 'transparent');
        ctxEdge.arc(x, y, mag * 1.5, 0, 2 * Math.PI);

        ctxEdge.fillStyle = gradient;
        ctxEdge.fill();
    });
}

function displayTargets(hits) {
    ctxBall.clearRect(0, 0, canvasEdge.width, canvasEdge.height);

    hits.forEach(function (hit) {
        var x = (hit % (width / 2)) * mag * 2,
            y = (Math.floor(hit / (width / 2))) * mag * 2,
            size = mag * 2;

        ctxBall.beginPath();
        ctxBall.fillRect(x, y, size, size);
        ctxBall.closePath();
        ctxBall.fill();
    });
}

function setViewOptions(width) {
    viewWidth = width;
    mag = canvasEdge.width / width;
    halfMag = mag / 2;
}

function disableControlButtons(disOrEnable) {
    var buttons = document.querySelectorAll('#controls button'), ii, len;
    len = buttons.length;
    for (ii = 0; ii < len; ii += 1) {
        buttons[ii].disabled = disOrEnable;
    }
}

function setControl(autoOrManual) {
    var disOrEnabled, controlButton = document.querySelector('#manual button');

    control = autoOrManual;
    if (control === 'manual') {
        document.querySelector('#manual button').innerHTML = 'Relinquish control';
        disableControlButtons(false);
    } else {
        document.querySelector('#manual button').innerHTML = 'Request manual control';
        disableControlButtons(true);
    }

    controlButton.disabled = false;
    disableControlButtons(disOrEnabled);
}

function senseStateReceived(senseState) {
    var jsonState = JSON.parse(senseState),
        jsonString = JSON.stringify(jsonState, null, '    ');

    width = jsonState.perceptions.dimensions[0];
    mag = 400 / width;
    halfMag = mag / 2;

    // only update screen if data is new
    if (hashCode(jsonString) !== stateHash) {
        stateHash = hashCode(jsonString);

        // Handle image dimension change
        if (viewWidth !== jsonState.perceptions.dimensions[0]) {
            setViewOptions(jsonState.perceptions.dimensions[0]);
        }

        document.querySelector('#state pre').innerHTML = jsonString;
        displayOverallBrightness(jsonState.perceptions.brightnessOverall);
        displayEdges(jsonState.perceptions.edges);
        displayTargets(jsonState.perceptions.targets);
    }
}

function displayMoods(moodString) {
    var moodData = JSON.parse(moodString),
        moodSelect = document.createElement("select"),
        moodOption,
        moodContainer = document.getElementById('moods');

    Object.keys(moodData).forEach(function(mood, index) {
        moodOption = document.createElement('option');
            moodOption.value = mood;
        if (index === 0) {
            moodOption.textContent = "Default (" + mood + ")";
        } else {
            moodOption.textContent = mood + " (" + moodData[mood] + "s)";
        }

        moodSelect.appendChild(moodOption);
    });
    moodContainer.innerHTML = "";
    moodContainer.appendChild(moodSelect);
}

function displayActions(actions) {
    console.log(actions);
}

function displayBehaviors(behaviorTable) {
    console.log(behaviorTable);
    var behaviors,
        bTable = document.getElementById("behaviorTable"),
        bTableRow;

    if (behaviorTable) {
        behaviors = JSON.parse(behaviorTable).default;
    } else {
        behaviors = [];
    }
    //behaviors = JSON.parse(behaviors);
    behaviors.forEach(function (behavior) {
        bTableRow = document.createElement("div");
        bTableRow.textContent = JSON.stringify(behavior);
        bTable.appendChild(bTableRow);
    });
}

function move(type) {
    socket.emit('move', type);
}

function manual() {
    var controlButton = document.querySelector('#manual button');

    controlButton.disabled = true;

    if (control === 'auto') {
        controlButton.innerHTML = 'Requesting manual control...';
        socket.emit('control', 'manual');
        setControl('manual');
    } else {
        controlButton.innerHTML = 'Requesting autonomous control...';
        socket.emit('control', 'auto');
        setControl('auto');
    }
}

function init() {
    disableControlButtons(true);

    socket = io({reconnection: false});

    canvasEdge = document.getElementById("edges");
    ctxEdge = canvasEdge.getContext("2d");

    canvasBall = document.getElementById('ball');
    ctxBall = canvasBall.getContext("2d");
    ctxBall.fillStyle = "rgba(255, 0, 255, 0.5)";

    socket.on("senseState", senseStateReceived);
    socket.on("moods", displayMoods);
    socket.on("actions", displayActions);
    socket.on("behaviors", displayBehaviors);
    socket.on("disconnect", function () {
        console.log('disconnected');
    });
}

init();

</script>
